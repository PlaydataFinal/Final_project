{% extends "base.html" %}
{% block content %}
<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>SimpleMap</title>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script
        src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=xlL1KP3xjQ1wWTjuJ7LXV3fgy9ceMjcW8hLpqLWP"></script>
</head>

<body>
    <div class="map_wrap">
        <div id="map_div" style="width:100%;height:400px;position:relative;overflow:hidden;"></div>
        <div id="menu_wrap" class="bg_white">
            <div class="option">
                <div>
                    <form id="route_form">
                        출발지 : <input type="text" id="departure" size="15" list="searchOption">
                        <datalist id="searchOption">
                            {% for x in tour %}
                            <option value="{{ x.Name }}" />
                            {% endfor %}
                        </datalist>
                        도착지 : <input type="text" id="destination" size="15" list="searchOption">
                        <datalist id="searchOption">
                            {% for x in tour %}
                            <option value="{{ x.Name }}" />
                            {% endfor %}
                        </datalist>
                        <select id="selectLevel">
                            <option value="0" selected="selected">교통최적+추천</option>
                            <option value="2">교통최적+최소시간</option>
                            <option value="3">교통최적+초보</option>
                            <option value="12">이륜차도로우선</option>
                            <option value="19">교통최적+어린이보호구역 회피</option>
                        </select>
                        <select id="year">
                            <option value="N" selected="selected">교통정보 표출 옵션</option>
                            <option value="Y">Y</option>
                            <option value="N">N</option>
                        </select>
                        <button type="button" id="btn_apply">검색</button>
                    </form>
                </div>
            </div>
            <hr>
            <div id="result"></div>
        </div>
    </div>

    <script>
        var map;
        var markerInfo;
        //출발지,도착지 마커
        var marker_s, marker_e, marker_p;
        //경로그림정보
        var drawInfoArr = [];
        var drawInfoArr2 = [];

        var chktraffic = [];
        var resultdrawArr = [];
        var resultMarkerArr = [];

        function initTmap() {
            map = new Tmapv2.Map("map_div", {
                center: new Tmapv2.LatLng(33.3655, 126.5330),
                width: "100%",
                height: "400px",
                zoom: 10,
                zoomControl: true,
                scrollwheel: true
            });
        }

        $(document).ready(function () {
            $("#btn_apply").click(function () {
                event.preventDefault(); // 기본 동작 방지

                // 이전에 추가된 마커와 라인 제거
                resettingMap();

                console.log("searchRoute 함수가 호출되었습니다.");
                var departure = $("#departure").val();
                var destination = $("#destination").val();
                var searchOption = $("#selectLevel").val();
                var trafficInfochk = $("#year").val();

                console.log("출발지:", departure);
                console.log("도착지:", destination);

                // 출발지와 도착지 좌표 요청
                $.ajax({
                    type: "GET",
                    url: `/tmapapi/get_tourist_spots/?departure=${departure}&destination=${destination}`,
                    success: function (data) {
                        console.log("받아온 데이터:", data);

                        // 출발지와 도착지 정보가 모두 없는 경우 처리
                        if (!departure && !destination) {
                            alert("출발지와 도착지 정보가 올바르지 않습니다.");
                            return;
                        }

                        // 출발지 정보가 없는 경우 처리
                        if (!departure) {
                            alert("출발지 정보가 올바르지 않습니다.");
                            return;
                        }

                        // 도착지 정보가 없는 경우 처리
                        if (!destination) {
                            alert("도착지 정보가 올바르지 않습니다.");
                            return;
                        }

                        // 출발지와 도착지 데이터 처리
                        var departureData = data.find(obj => obj.Name === departure);
                        var destinationData = data.find(obj => obj.Name === destination);

                        // 출발지와 도착지 데이터가 모두 존재하는 경우에만 처리
                        if (departureData && destinationData) {
                            var departureLatitude = departureData.Latitude;
                            var departureLongitude = departureData.Longitude;
                            var destinationLatitude = destinationData.Latitude;
                            var destinationLongitude = destinationData.Longitude;

                            // 출발지와 도착지 마커 생성
                            createMarkers(departureLatitude, departureLongitude, destinationLatitude, destinationLongitude);

                            // 마커 생성 후 마커 위치 출력
                            console.log(marker_s.getPosition().lat());

                            // 경로 검색
                            searchRoute(departureLongitude, departureLatitude, destinationLongitude, destinationLatitude, searchOption, trafficInfochk);
                        } else {
                            if (!departureData) {
                                alert("출발지 정보가 올바르지 않습니다.");
                            }
                            if (!destinationData) {
                                alert("도착지 정보가 올바르지 않습니다.");
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("오류 발생:", error);
                        alert("검색 중 오류가 발생했습니다.");
                    }
                });
            });
        });


        function createMarkers(departureLatitude, departureLongitude, destinationLatitude, destinationLongitude) {
            // 기존 마커들 삭제
            if (marker_s) {
                marker_s.setMap(null);
            }
            if (marker_e) {
                marker_e.setMap(null);
            }

            // 출발지 마커 생성
            marker_s = new Tmapv2.Marker({
                position: new Tmapv2.LatLng(departureLatitude, departureLongitude), // 출발지의 위도와 경도
                icon: "../static/assets/img/pin_r_m_s.png/pin_r_m_s.png",
                map: map
            });

            // 도착지 마커 생성
            marker_e = new Tmapv2.Marker({
                position: new Tmapv2.LatLng(destinationLatitude, destinationLongitude), // 도착지의 위도와 경도
                icon: "../static/assets/img/pin_r_m_s.png/pin_r_m_e.png",
                map: map
            });

            // 생성된 마커들을 배열에 추가
            resultMarkerArr.push(marker_s);
            resultMarkerArr.push(marker_e);
        }


        function searchRoute(departureLongitude, departureLatitude, destinationLongitude, destinationLatitude, searchOption, trafficInfochk) {
            var headers = {};
            headers["appKey"] = "xlL1KP3xjQ1wWTjuJ7LXV3fgy9ceMjcW8hLpqLWP";

            $.ajax({
                type: "POST",
                headers: headers,
                url: "https://apis.openapi.sk.com/tmap/routes?version=1&format=json&callback=result",
                async: false,
                data: {
                    "startX": departureLongitude,
                    "startY": departureLatitude,
                    "endX": destinationLongitude,
                    "endY": destinationLatitude,
                    "reqCoordType": "WGS84GEO",
                    "resCoordType": "EPSG3857",
                    "searchOption": searchOption,
                    "trafficInfo": trafficInfochk
                },
                success: function (response) {
                    var resultData = response.features;
                    var tDistance = "총 거리 : " + (resultData[0].properties.totalDistance / 1000).toFixed(1) + "km,";
                    var tTime = " 총 시간 : " + (resultData[0].properties.totalTime / 60).toFixed(0) + "분,";
                    // var tFare = " 총 요금 : " + resultData[0].properties.totalFare + "원,";
                    var taxiFare = " 예상 택시 요금 : " + resultData[0].properties.taxiFare + "원";

                    $("#result").text(tDistance + tTime + taxiFare);

                    for (var i in resultData) {
                        var geometry = resultData[i].geometry;
                        var properties = resultData[i].properties;

                        if (geometry.type == "LineString") {
                            var sectionInfos = [];
                            var trafficArr = geometry.traffic;

                            for (var j in geometry.coordinates) {
                                var latlng = new Tmapv2.Point(geometry.coordinates[j][0], geometry.coordinates[j][1]);
                                var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(latlng);
                                sectionInfos.push(convertPoint);
                            }

                            drawLine(sectionInfos, trafficArr);
                        } else {
                            var markerImg = "";
                            var pType = "";

                            if (properties.pointType == "S") {
                                markerImg = "../static/assets/img/pin_r_m_s.png/pin_r_m_s.png";
                                pType = "S";
                            } else if (properties.pointType == "E") {
                                markerImg = "../static/assets/img/pin_r_m_s.png/pin_r_m_e.png";
                                pType = "E";
                            } else {
                                markerImg = "http://topopen.tmap.co.kr/imgs/point.png";
                                pType = "P"
                            }

                            var latlon = new Tmapv2.Point(geometry.coordinates[0], geometry.coordinates[1]);
                            var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(latlon);

                            var routeInfoObj = {
                                markerImage: markerImg,
                                lng: convertPoint._lng,
                                lat: convertPoint._lat,
                                pointType: pType
                            };

                            addMarkers(routeInfoObj);
                        }
                    }
                },
                error: function (request, status, error) {
                    console.log("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                }
            });
        }

        function addMarkers(infoObj) {
            var size = new Tmapv2.Size(24, 38);

            if (infoObj.pointType == "P") {
                size = new Tmapv2.Size(8, 8);
            }

            var marker_p = new Tmapv2.Marker({
                position: new Tmapv2.LatLng(infoObj.lat, infoObj.lng),
                icon: infoObj.markerImage,
                iconSize: size,
                map: map
            });

            resultMarkerArr.push(marker_p);
        }

        // 라인을 그리는 함수
        function drawLine(arrPoint, traffic, pointType) {
            var polyline_;
            var lineColor = "#06050D"; // 기본 라인 색상

            if (traffic && traffic.length > 0) { // traffic이 정의되어 있고 길이가 0보다 큰 경우에만 실행
                var tInfo = [];

                for (var z = 0; z < traffic.length; z++) {
                    var trafficObject = {
                        "startIndex": traffic[z][0],
                        "endIndex": traffic[z][1],
                        "trafficIndex": traffic[z][2],
                    };
                    tInfo.push(trafficObject);
                }

                for (var x = 0; x < tInfo.length; x++) {
                    var sectionPoint = [];

                    for (var y = tInfo[x].startIndex; y <= tInfo[x].endIndex; y++) {
                        sectionPoint.push(arrPoint[y]);
                    }

                    switch (tInfo[x].trafficIndex) {
                        case 0:
                            lineColor = "#06050D"; // 검정색
                            break;
                        case 1:
                            lineColor = "#61AB25"; // 녹색
                            break;
                        case 2:
                            lineColor = "#FFFF00"; // 노란색
                            break;
                        case 3:
                            lineColor = "#E87506"; // 주황색
                            break;
                        case 4:
                            lineColor = "#D61125"; // 빨간색
                            break;
                        default:
                            lineColor = "#06050D";
                            break;
                    }

                    polyline_ = new Tmapv2.Polyline({
                        path: sectionPoint,
                        strokeColor: lineColor,
                        strokeWeight: 6,
                        map: map
                    });

                    resultdrawArr.push(polyline_);
                }
            } else {
                polyline_ = new Tmapv2.Polyline({
                    path: arrPoint,
                    strokeColor: "#DD0000", // 빨간색
                    strokeWeight: 6,
                    map: map
                });

                resultdrawArr.push(polyline_);
            }

            // 출발지와 도착지 마커 처리
            if (pointType === "S") {
                marker_s.setMap(map);
                if (marker_e.getPosition()) { // 도착지 마커가 있는 경우
                    var line = new Tmapv2.Polyline({
                        path: [marker_s.getPosition(), marker_e.getPosition()],
                        strokeColor: "#06050D",
                        strokeWeight: 6,
                        map: map
                    });
                    resultdrawArr.push(line);
                }
            } else if (pointType === "E") {
                marker_e.setMap(map);
                if (marker_s.getPosition()) { // 출발지 마커가 있는 경우
                    var line = new Tmapv2.Polyline({
                        path: [marker_s.getPosition(), marker_e.getPosition()],
                        strokeColor: "#06050D",
                        strokeWeight: 6,
                        map: map
                    });
                    resultdrawArr.push(line);
                }
            }
        }

        // 초기화 기능
        function resettingMap() {
            // 출발지와 도착지 마커 삭제
            if (marker_s) {
                marker_s.setMap(null);
            }
            if (marker_e) {
                marker_e.setMap(null);
            }

            // 기존 마커 삭제
            if (resultMarkerArr.length > 0) {
                for (var i = 0; i < resultMarkerArr.length; i++) {
                    resultMarkerArr[i].setMap(null);
                }
            }

            // 기존 라인 삭제
            if (resultdrawArr.length > 0) {
                for (var i = 0; i < resultdrawArr.length; i++) {
                    resultdrawArr[i].setMap(null);
                }
            }

            // 배열 초기화
            chktraffic = [];
            drawInfoArr = [];
            resultMarkerArr = [];
            resultdrawArr = [];
        }


        // Tmap 지도 초기화
        initTmap();
    </script>
</body>

</html>
{% endblock %}